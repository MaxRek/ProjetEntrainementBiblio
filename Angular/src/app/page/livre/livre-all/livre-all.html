<h1>Liste des livres</h1>

<form (ngSubmit)="creerOuModifierLivre()" [formGroup]="livreForm">
  <div>
    <label for="titre">Titre</label>
    <input id="titre" type="text" formControlName="titre" />

    @if (titreCtrl.hasError('required') && titreCtrl.touched) {
      <span>Le titre est obligatoire</span>
    }
  </div>

  <div>
    <label for="resumer">Résumé</label>
    <textarea id="resumer" formControlName="resumer"></textarea>

    @if (resumerCtrl.hasError('required') && resumerCtrl.touched) {
      <span>Le résumé est obligatoire</span>
    }
    @if (resumerCtrl.hasError('maxlength') && resumerCtrl.touched) {
      <span>Le résumé ne doit pas dépasser 500 caractères</span>
    }
  </div>

  <div>
    <label for="annee">Année</label>
    <input id="annee" type="text" formControlName="annee" />

    @if (anneeCtrl.hasError('required') && anneeCtrl.touched) {
      <span>L'année est obligatoire</span>
    }
    @if ((anneeCtrl.hasError('minlength') || anneeCtrl.hasError('maxlength')) && anneeCtrl.touched) {
      <span>L'année doit contenir exactement 4 caractères</span>
    }
  </div>

  <!-- Auteur -->
  <div>
    <label for="auteur">Auteur</label>
    <select id="auteur" formControlName="auteur">
      <option [ngValue]="null">-- Choisir un auteur --</option>
      <option
        *ngFor="let auteur of (auteurs$ | async); trackBy: trackAuteur"
        [ngValue]="auteur">
        {{ auteur.nom }}
      </option>
    </select>

    @if (auteurCtrl.hasError('required') && auteurCtrl.touched) {
      <span>L'auteur est obligatoire</span>
    }
  </div>

  <!-- Éditeur -->
  <div>
    <label for="editeur">Éditeur</label>
    <select id="editeur" formControlName="editeur">
      <option [ngValue]="null">-- Choisir un éditeur --</option>
      <option
        *ngFor="let editeur of (editeurs$ | async); trackBy: trackEditeur"
        [ngValue]="editeur">
        {{ editeur.nom }}
      </option>
    </select>

    @if (editeurCtrl.hasError('required') && editeurCtrl.touched) {
      <span>L'éditeur est obligatoire</span>
    }
  </div>

  <!-- Collection (optionnelle) -->
  <div>
    <label for="collection">Collection</label>
    <select id="collection" formControlName="collection">
      <option [ngValue]="null">-- Aucune --</option>
      <option
        *ngFor="let collection of (collections$ | async); trackBy: trackCollection"
        [ngValue]="collection">
        {{ collection.nom }}
      </option>
    </select>
  </div>

  @if (editingLivre) {
    <input type="submit" [disabled]="livreForm.invalid" value="Modifier" />
  } @else {
    <input type="submit" [disabled]="livreForm.invalid" value="Créer" />
  }
</form>

<hr />

<table>
  <thead>
    <tr>
      <th>Titre</th>
      <th>Année</th>
      <th>Auteur</th>
      <th>Éditeur</th>
      <th>Collection</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let livre of (livres$ | async); trackBy: trackLivre">
      <td>
        <a [routerLink]="['/livre', livre.id]">{{ livre.titre }}</a>
      </td>
      <td>{{ livre.annee }}</td>
      <td>{{ livre.auteur?.nom }}</td>
      <td>{{ livre.editeur?.nom }}</td>
      <td>{{ livre.collection?.nom }}</td>
      <td>
        <button type="button" (click)="editer(livre)">Modifier</button>
        <button type="button" (click)="supprimerLivre(livre)">Supprimer</button>
      </td>
    </tr>
  </tbody>
</table>
